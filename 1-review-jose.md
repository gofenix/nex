# Nex æ¡†æ¶æŠ€æœ¯è¯„å®¡æŠ¥å‘Š

**è¯„å®¡äºº**: JosÃ© Valim (Elixir è¯­è¨€åˆ›å§‹äºº)  
**è¯„å®¡æ—¥æœŸ**: 2024å¹´12æœˆ  
**æ¡†æ¶ç‰ˆæœ¬**: 0.1.0

---

## æ‰§è¡Œæ‘˜è¦

Nex æ˜¯ä¸€ä¸ªæç®€ä¸»ä¹‰çš„ Elixir Web æ¡†æ¶ï¼Œä»¥ HTMX ä¸ºæ ¸å¿ƒé©±åŠ¨åŠ›ã€‚ä½œä¸º Elixir è¯­è¨€çš„åˆ›å§‹äººï¼Œæˆ‘å¯¹è¿™ä¸ªé¡¹ç›®è¿›è¡Œäº†æ·±å…¥çš„ä»£ç å®¡è®¡ã€‚**æ€»ä½“è€Œè¨€ï¼ŒNex å±•ç°äº†å¯¹ Elixir ç”Ÿæ€ç³»ç»Ÿçš„æ·±åˆ»ç†è§£ï¼Œä»¥åŠå¯¹ç°ä»£ Web å¼€å‘"å°‘å³æ˜¯å¤š"å“²å­¦çš„è®¤åŒ**ã€‚

æ¡†æ¶çš„æ ¸å¿ƒç†å¿µâ€”â€”ç”¨æœ€å°‘çš„ä»£ç å®ç°æœ€å¤§çš„ä»·å€¼â€”â€”ä¸ Elixir çš„è®¾è®¡å“²å­¦é«˜åº¦ä¸€è‡´ã€‚ç„¶è€Œï¼Œä½œä¸ºä¸€ä¸ªæ—©æœŸç‰ˆæœ¬ï¼Œä»æœ‰è‹¥å¹²æ¶æ„å†³ç­–å’Œå®ç°ç»†èŠ‚å€¼å¾—æ·±å…¥æ¢è®¨å’Œæ”¹è¿›ã€‚

---

## 1. æ¶æ„è¯„ä¼°

### 1.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nex æ¡†æ¶æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·åº”ç”¨å±‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Pages   â”‚ â”‚   API   â”‚ â”‚ Partialsâ”‚ â”‚   SSE   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚           â”‚           â”‚           â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¡†æ¶æ ¸å¿ƒå±‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Nex.Handler                     â”‚    â”‚
â”‚  â”‚  (è·¯ç”±è§£æ + è¯·æ±‚åˆ†å‘ + å“åº”å¤„ç†)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Nex.Store  â”‚ â”‚Nex.Reloaderâ”‚ â”‚ Nex.Env  â”‚         â”‚
â”‚  â”‚(çŠ¶æ€ç®¡ç†) â”‚ â”‚ (çƒ­é‡è½½)   â”‚ â”‚(ç¯å¢ƒå˜é‡) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸºç¡€è®¾æ–½å±‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Bandit  â”‚ â”‚Phoenix.PubSubâ”‚ â”‚Phoenix.LiveView â”‚   â”‚
â”‚  â”‚(HTTP)   â”‚ â”‚  (æ¶ˆæ¯)      â”‚ â”‚   (HEEx)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**:
- **å±‚æ¬¡æ¸…æ™°**: ç”¨æˆ·ä»£ç ä¸æ¡†æ¶ä»£ç åˆ†ç¦»è‰¯å¥½
- **çº¦å®šä¼˜äºé…ç½®**: æ–‡ä»¶è·¯å¾„å³è·¯ç”±ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
- **ä¾èµ–ç²¾ç®€**: åŸºäº Bandit + Plugï¼Œé¿å… Phoenix å…¨å®¶æ¡¶çš„å¤æ‚æ€§

**æ”¹è¿›å»ºè®®**:
- `Nex.Handler` æ‰¿æ‹…äº†è¿‡å¤šèŒè´£ï¼ˆ665è¡Œï¼‰ï¼Œå»ºè®®æ‹†åˆ†ä¸ºç‹¬ç«‹æ¨¡å—

### 1.2 æ¨¡å—èŒè´£åˆ†æ

| æ¨¡å— | è¡Œæ•° | èŒè´£ | è¯„ä»· |
|------|------|------|------|
| `Nex.Handler` | 665 | è·¯ç”±è§£æã€è¯·æ±‚åˆ†å‘ã€å“åº”å¤„ç†ã€SSEã€é”™è¯¯é¡µé¢ | âš ï¸ è¿‡äºè‡ƒè‚¿ |
| `Nex.Store` | 162 | é¡µé¢çº§çŠ¶æ€ç®¡ç† | âœ… è®¾è®¡ç²¾è‰¯ |
| `Nex.Reloader` | 85 | çƒ­é‡è½½ | âœ… ç®€æ´é«˜æ•ˆ |
| `Nex.Router` | 27 | Plug è·¯ç”±å…¥å£ | âœ… æç®€ |
| `Nex.Page` | 41 | é¡µé¢æ¨¡å—å® | âœ… åˆç† |
| `Nex.Api` | 40 | API æ¨¡å—å® | âš ï¸ è¿‡äºç©ºæ´ |
| `Nex.SSE` | 58 | SSE è¡Œä¸ºå®šä¹‰ | âœ… è®¾è®¡è‰¯å¥½ |
| `Nex.Env` | 84 | ç¯å¢ƒå˜é‡ç®¡ç† | âœ… å®ç”¨ |
| `Nex.Supervisor` | 35 | è¿›ç¨‹ç›‘ç£ | âœ… OTP æ ‡å‡† |

---

## 2. æ ¸å¿ƒè®¾è®¡æ·±åº¦åˆ†æ

### 2.1 çº¦å®šå¼è·¯ç”± (Convention-based Routing)

**è®¾è®¡ç†å¿µ**: æ–‡ä»¶ç³»ç»Ÿç»“æ„å³è·¯ç”±é…ç½®

```elixir
# æ–‡ä»¶è·¯å¾„ â†’ HTTP è·¯ç”±
src/pages/index.ex      â†’ GET /
src/pages/about.ex      â†’ GET /about
src/pages/todos/[id].ex â†’ GET /todos/:id
src/api/todos/index.ex  â†’ GET/POST /api/todos
```

**å®ç°åˆ†æ** (`Nex.Handler` ç¬¬488-513è¡Œ):

```elixir
defp resolve_page_module(path) do
  app_module = get_app_module()
  {module_parts, params} = path_to_module_parts(path)
  
  module_name = [app_module, "Pages" | module_parts] |> Enum.join(".")
  
  case safe_to_existing_module(module_name) do
    {:ok, module} -> {:ok, module, params}
    :error ->
      # Try index
      case safe_to_existing_module("#{module_name}.Index") do
        {:ok, index_module} -> {:ok, index_module, params}
        :error -> :error
      end
  end
end
```

**JosÃ© çš„è¯„ä»·**:

âœ… **ä¼˜ç‚¹**:
- ä½¿ç”¨ `String.to_existing_atom/1` é˜²æ­¢åŸå­è€—å°½æ”»å‡»ï¼Œè¿™æ˜¯æ­£ç¡®çš„å®‰å…¨å®è·µ
- è‡ªåŠ¨å›é€€åˆ° `Index` å­æ¨¡å—ï¼Œç¬¦åˆå¸¸è§çº¦å®š

âš ï¸ **é—®é¢˜**:
1. **åŠ¨æ€æ®µæ£€æµ‹è¿‡äºç®€å•**:
```elixir
defp is_dynamic_segment?(segment) do
  String.match?(segment, ~r/^[0-9a-f-]+$/i)
end
```
è¿™åªèƒ½è¯†åˆ«æ•°å­—å’Œ UUIDï¼Œæ— æ³•å¤„ç† `my-slug-123` è¿™æ ·çš„ slugã€‚å»ºè®®æ”¯æŒ `[param]` æ–‡ä»¶åçº¦å®šã€‚

2. **ç¼ºå°‘è·¯ç”±ç¼“å­˜**: æ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°è§£ææ¨¡å—åï¼Œåº”è€ƒè™‘ç¼–è¯‘æ—¶è·¯ç”±è¡¨ç”Ÿæˆã€‚

### 2.2 é¡µé¢çº§çŠ¶æ€ç®¡ç† (Nex.Store)

è¿™æ˜¯æ¡†æ¶æœ€å…·åˆ›æ–°æ€§çš„è®¾è®¡ä¹‹ä¸€ã€‚

**æ ¸å¿ƒæ€æƒ³**: ç±»ä¼¼ React çš„ `useState`ï¼Œä½†ä½œç”¨åŸŸæ˜¯æ•´ä¸ªé¡µé¢ä¼šè¯ã€‚

```elixir
# çŠ¶æ€å­˜å‚¨ç»“æ„
# ETS: {{page_id, key}, value, expires_at}

def get(key, default \\ nil) do
  page_id = get_page_id()
  case :ets.lookup(@table, {page_id, key}) do
    [{_, value, _expires_at}] -> value
    [] -> default
  end
end
```

**JosÃ© çš„è¯„ä»·**:

âœ… **ä¼˜ç‚¹**:
1. **ETS é€‰æ‹©æ­£ç¡®**: å…¬å…±è¡¨å…è®¸è·¨è¿›ç¨‹è®¿é—®ï¼Œè¿™å¯¹äº Web è¯·æ±‚å¤„ç†è‡³å…³é‡è¦
2. **TTL æœºåˆ¶**: 1å°æ—¶è¿‡æœŸ + 5åˆ†é’Ÿæ¸…ç†å‘¨æœŸï¼Œæœ‰æ•ˆé˜²æ­¢å†…å­˜æ³„æ¼
3. **è¿›ç¨‹å­—å…¸ä¼ é€’ page_id**: ç®€åŒ–äº† APIï¼Œç”¨æˆ·æ— éœ€æ˜¾å¼ä¼ é€’

âš ï¸ **é—®é¢˜**:

1. **`touch_page` æ€§èƒ½é—®é¢˜**:
```elixir
defp touch_page(page_id) do
  :ets.match(@table, {{page_id, :"$1"}, :"$2", :_})
  |> Enum.each(fn [key, value] ->
    :ets.insert(@table, {{page_id, key}, value, expires_at})
  end)
end
```
æ¯æ¬¡è¯·æ±‚éƒ½ä¼šéå†å¹¶é‡å†™æ‰€æœ‰è¯¥é¡µé¢çš„æ¡ç›®ã€‚å½“é¡µé¢çŠ¶æ€è¾ƒå¤šæ—¶ï¼Œè¿™æ˜¯ O(n) çš„å†™æ“ä½œã€‚

**å»ºè®®**: ä½¿ç”¨ç‹¬ç«‹çš„ `{:page_meta, page_id}` æ¡ç›®å­˜å‚¨æœ€åè®¿é—®æ—¶é—´ï¼Œæ¸…ç†æ—¶åŸºäºæ­¤åˆ¤æ–­ã€‚

2. **ç¼ºå°‘è®¢é˜…æœºåˆ¶**: æ— æ³•å®ç°ç±»ä¼¼ LiveView çš„å®æ—¶çŠ¶æ€åŒæ­¥ã€‚è¿™å¯èƒ½æ˜¯æœ‰æ„ä¸ºä¹‹ï¼ˆä¿æŒç®€å•ï¼‰ï¼Œä½†å€¼å¾—åœ¨æ–‡æ¡£ä¸­è¯´æ˜ã€‚

### 2.3 SSE æµå¼å“åº”

**è®¾è®¡äº®ç‚¹**: é€šè¿‡ `use Nex.SSE` æ ‡è®°æ¨¡å—ä¸º SSE ç«¯ç‚¹ï¼Œæ¡†æ¶è‡ªåŠ¨è¯†åˆ«å¹¶ç‰¹æ®Šå¤„ç†ã€‚

```elixir
defmacro __using__(_opts) do
  quote do
    @behaviour Nex.SSE
    def __sse_endpoint__, do: true  # æ ‡è®°å‡½æ•°
  end
end
```

**Handler ä¸­çš„è¯†åˆ«é€»è¾‘**:
```elixir
is_sse = Code.ensure_loaded?(module) and 
         function_exported?(module, :__sse_endpoint__, 0)
```

**JosÃ© çš„è¯„ä»·**:

âœ… **ä¼˜ç‚¹**:
- å›è°ƒå¼ API (`stream/2`) è®¾è®¡ä¼˜é›…ï¼Œå…è®¸å®æ—¶æ¨é€
- è‡ªåŠ¨å¤„ç† SSE æ ¼å¼åŒ–ï¼Œç”¨æˆ·åªéœ€å…³æ³¨ä¸šåŠ¡é€»è¾‘

âš ï¸ **é—®é¢˜**:

1. **é”™è¯¯å¤„ç†ä¸å®Œæ•´**:
```elixir
defp send_sse_stream(conn, module, params) do
  # ...
catch
  :closed -> :ok  # åªæ•è·äº† :closed
end
```
å…¶ä»–å¼‚å¸¸ä¼šå¯¼è‡´è¿æ¥å¼‚å¸¸ç»ˆæ­¢ã€‚å»ºè®®å¢åŠ é€šç”¨å¼‚å¸¸å¤„ç†å’Œå®¢æˆ·ç«¯é€šçŸ¥ã€‚

2. **ç¼ºå°‘å¿ƒè·³æœºåˆ¶**: é•¿è¿æ¥å¯èƒ½å› ä¸ºç½‘ç»œä¸­é—´ä»¶è¶…æ—¶è€Œæ–­å¼€ï¼Œåº”å®šæœŸå‘é€ `:ping` äº‹ä»¶ã€‚

### 2.4 çƒ­é‡è½½æœºåˆ¶

```elixir
defp reload_file(path, state) do
  try do
    Code.compile_file(path)
    Phoenix.PubSub.broadcast(Nex.PubSub, "live_reload", {:reload, path})
    %{state | last_reload: System.system_time(:millisecond)}
  rescue
    e -> Logger.error("[Nex.Reloader] âœ— Compile error: #{Exception.message(e)}")
  end
end
```

**JosÃ© çš„è¯„ä»·**:

âœ… **ä¼˜ç‚¹**:
- ä½¿ç”¨ `file_system` ç›‘å¬å˜æ›´ï¼Œè¿™æ˜¯æ­£ç¡®çš„åšæ³•
- é€šè¿‡ PubSub + WebSocket é€šçŸ¥æµè§ˆå™¨ï¼Œæ— éœ€è½®è¯¢

âš ï¸ **é—®é¢˜**:

1. **`Code.compile_file/1` çš„å±€é™æ€§**:
   - ä¸ä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘ä¾èµ–æ­¤æ¨¡å—çš„å…¶ä»–æ¨¡å—
   - æ¨¡å—é‡å‘½åæˆ–åˆ é™¤æ—¶ï¼Œæ—§æ¨¡å—ä»å­˜åœ¨äºå†…å­˜ä¸­

**å»ºè®®**: è€ƒè™‘ä½¿ç”¨ `IEx.Helpers.recompile/0` æˆ–æ‰‹åŠ¨è·Ÿè¸ªæ¨¡å—ä¾èµ–ã€‚

2. **ç”Ÿäº§ç¯å¢ƒé£é™©**: `Nex.Reloader` åœ¨ç”Ÿäº§ç¯å¢ƒä¹Ÿä¼šå¯åŠ¨ï¼Œåº”å¢åŠ ç¯å¢ƒæ£€æŸ¥ã€‚

---

## 3. å®‰å…¨æ€§åˆ†æ

### 3.1 åŸå­è€—å°½é˜²æŠ¤ âœ…

```elixir
defp safe_to_existing_atom(string) do
  {:ok, String.to_existing_atom(string)}
rescue
  ArgumentError -> :error
end
```

**è¯„ä»·**: æ­£ç¡®ä½¿ç”¨ `to_existing_atom`ï¼Œè¿™æ˜¯é˜²æ­¢åŸå­è¡¨è€—å°½çš„æ ‡å‡†åšæ³•ã€‚

### 3.2 HTML è½¬ä¹‰ âœ…

```elixir
defp html_escape(text) when is_binary(text) do
  text
  |> String.replace("&", "&amp;")
  |> String.replace("<", "&lt;")
  |> String.replace(">", "&gt;")
  |> String.replace("\"", "&quot;")
end
```

**è¯„ä»·**: é”™è¯¯é¡µé¢ä¸­æ­£ç¡®è½¬ä¹‰äº†ç”¨æˆ·è¾“å…¥ã€‚HEEx æ¨¡æ¿é»˜è®¤ä¹Ÿä¼šè½¬ä¹‰ã€‚

### 3.3 æ½œåœ¨é—®é¢˜ âš ï¸

1. **page_id å¯é¢„æµ‹æ€§**:
```elixir
def generate_page_id do
  :crypto.strong_rand_bytes(12) |> Base.url_encode64()
end
```
è™½ç„¶ä½¿ç”¨äº†åŠ å¯†éšæœºæ•°ï¼Œä½† 12 å­—èŠ‚ï¼ˆ96ä½ï¼‰å¯¹äºæ•æ„Ÿåº”ç”¨å¯èƒ½ä¸å¤Ÿã€‚å»ºè®®å¢åŠ åˆ° 16 å­—èŠ‚ã€‚

2. **ç¼ºå°‘ CSRF é˜²æŠ¤**: HTMX POST è¯·æ±‚æ²¡æœ‰ CSRF token éªŒè¯ã€‚å¯¹äºå†…éƒ¨åº”ç”¨å¯èƒ½å¯ä»¥æ¥å—ï¼Œä½†åº”åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜ã€‚

3. **API è®¤è¯ç¼ºå¤±**: `Nex.Api` æ¨¡å—æ²¡æœ‰æä¾›è®¤è¯/æˆæƒé’©å­ï¼Œå®Œå…¨ä¾èµ–ç”¨æˆ·è‡ªè¡Œå®ç°ã€‚

---

## 4. æ€§èƒ½åˆ†æ

### 4.1 è¯·æ±‚å¤„ç†è·¯å¾„

```
è¯·æ±‚ â†’ Plug.Parsers â†’ Nex.Router â†’ Nex.Handler
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                   â–¼                   â–¼
              resolve_page_module  resolve_api_module  handle_sse
                    â”‚                   â”‚                   â”‚
                    â–¼                   â–¼                   â–¼
              String.to_existing_atom (å¯èƒ½å¤±è´¥å¹¶ rescue)
                    â”‚
                    â–¼
              Code.ensure_loaded? (ç£ç›˜/å†…å­˜æ£€æŸ¥)
                    â”‚
                    â–¼
              function_exported? (å‡½æ•°è¡¨æŸ¥æ‰¾)
```

**æ€§èƒ½ç“¶é¢ˆ**:

1. **æ¨¡å—è§£æå¼€é”€**: æ¯ä¸ªè¯·æ±‚éƒ½è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ + åŸå­è½¬æ¢ + æ¨¡å—åŠ è½½æ£€æŸ¥
2. **ETS è®¿é—®**: `Nex.Store` çš„ `touch_page` åœ¨é«˜å¹¶å‘ä¸‹å¯èƒ½æˆä¸ºç“¶é¢ˆ

**å»ºè®®ä¼˜åŒ–**:

```elixir
# ç¼–è¯‘æ—¶ç”Ÿæˆè·¯ç”±è¡¨
defmodule Nex.Routes do
  @routes %{
    {"GET", []} => {MyApp.Pages.Index, []},
    {"GET", ["about"]} => {MyApp.Pages.About, []},
    # ...
  }
  
  def lookup(method, path), do: Map.get(@routes, {method, path})
end
```

### 4.2 å†…å­˜ä½¿ç”¨

- **ETS è¡¨**: å•è¡¨å­˜å‚¨æ‰€æœ‰é¡µé¢çŠ¶æ€ï¼Œå†…å­˜å ç”¨ä¸æ´»è·ƒé¡µé¢æ•°æˆæ­£æ¯”
- **è¿›ç¨‹å­—å…¸**: æ¯ä¸ªè¯·æ±‚å­˜å‚¨ page_idï¼Œè¯·æ±‚ç»“æŸåæ¸…ç† âœ…

---

## 5. Elixir æƒ¯ç”¨æ³•è¯„ä¼°

### 5.1 ç¬¦åˆæƒ¯ç”¨æ³• âœ…

1. **OTP ç›‘ç£æ ‘**:
```elixir
def init(_opts) do
  children = [
    {Phoenix.PubSub, name: Nex.PubSub},
    Nex.Store,
    Nex.Reloader
  ]
  Supervisor.init(children, strategy: :one_for_one)
end
```

2. **GenServer çŠ¶æ€ç®¡ç†**: `Nex.Store` å’Œ `Nex.Reloader` æ­£ç¡®ä½¿ç”¨ GenServer

3. **è¡Œä¸ºå®šä¹‰**: `Nex.SSE` ä½¿ç”¨ `@behaviour` å’Œ `@callback` å®šä¹‰å¥‘çº¦

### 5.2 å¯æ”¹è¿›ä¹‹å¤„ âš ï¸

1. **è¿‡åº¦ä½¿ç”¨ `try/rescue`**:
```elixir
defp safe_to_existing_atom(string) do
  {:ok, String.to_existing_atom(string)}
rescue
  ArgumentError -> :error
end
```
åœ¨ Elixir ä¸­ï¼Œå¼‚å¸¸åº”ç”¨äº"çœŸæ­£çš„å¼‚å¸¸æƒ…å†µ"ã€‚è¿™é‡Œå¯ä»¥æ”¹ç”¨ï¼š
```elixir
defp safe_to_existing_atom(string) do
  if :erlang.list_to_atom(String.to_charlist(string)) in :erlang.registered() do
    # ...
  end
end
```
æˆ–è€…æ¥å—è¿™æ˜¯çƒ­è·¯å¾„çš„å¿…è¦ tradeoffã€‚

2. **ç¼ºå°‘ç±»å‹è§„èŒƒ**: å‡ ä¹æ²¡æœ‰ `@spec` å®šä¹‰ï¼Œä¸åˆ©äº Dialyzer é™æ€åˆ†æ

3. **é­”æ³•å­—ç¬¦ä¸²**: 
```elixir
case path do
  ["api" | rest] -> ...
  ["sse" | rest] -> ...
```
å»ºè®®ä½¿ç”¨æ¨¡å—å±æ€§æˆ–é…ç½®ï¼š
```elixir
@api_prefix Application.compile_env(:nex, :api_prefix, "api")
```

---

## 6. ä¸ Phoenix/LiveView çš„å¯¹æ¯”

| ç»´åº¦ | Nex | Phoenix LiveView |
|------|-----|------------------|
| **å¤æ‚åº¦** | ~1200 è¡Œæ ¸å¿ƒä»£ç  | ~50000+ è¡Œ |
| **å­¦ä¹ æ›²çº¿** | ä½ | ä¸­-é«˜ |
| **å®æ—¶æ›´æ–°** | HTMX éƒ¨åˆ†åˆ·æ–° | WebSocket åŒå‘é€šä¿¡ |
| **çŠ¶æ€ç®¡ç†** | æ˜¾å¼ ETS å­˜å‚¨ | è¿›ç¨‹çŠ¶æ€ + assigns |
| **æœåŠ¡ç«¯æ¸²æŸ“** | HEEx | HEEx |
| **JS ä¾èµ–** | HTMX (~14KB) | Phoenix.JS (~20KB) |
| **é€‚ç”¨åœºæ™¯** | ç®€å• CRUDã€å†…éƒ¨å·¥å…· | å¤æ‚å®æ—¶åº”ç”¨ |

**JosÃ© çš„è§‚ç‚¹**:

Nex ä¸æ˜¯ Phoenix çš„æ›¿ä»£å“ï¼Œè€Œæ˜¯**è¡¥å……**ã€‚å®ƒå¡«è¡¥äº†"æ¯”çº¯é™æ€é¡µé¢å¤æ‚ä¸€ç‚¹ï¼Œä½†ä¸éœ€è¦ LiveView å…¨éƒ¨åŠŸèƒ½"çš„ç©ºç™½ã€‚è¿™ä¸ªå®šä½æ˜¯æ˜æ™ºçš„ã€‚

Phoenix LiveView çš„å¤æ‚æ€§æ¥è‡ªäºå®ƒéœ€è¦å¤„ç†ï¼š
- WebSocket è¿æ¥ç®¡ç†å’Œé‡è¿
- DOM å·®å¼‚è®¡ç®—å’Œè¡¥ä¸åº”ç”¨
- çŠ¶æ€åŒæ­¥å’Œå†²çªè§£å†³
- è¡¨å•æ¢å¤å’Œä¹è§‚æ›´æ–°

å¦‚æœä½ çš„åº”ç”¨ä¸éœ€è¦è¿™äº›ï¼ŒNex çš„ç®€å•æ¨¡å‹å¯èƒ½æ›´åˆé€‚ã€‚

---

## 7. ç¤ºä¾‹é¡¹ç›®è¯„ä¼°

### 7.1 Todos ç¤ºä¾‹

**ä»£ç è´¨é‡**: â­â­â­â­â­

```elixir
def create_todo(%{"text" => text}) do
  todo = %{
    id: System.unique_integer([:positive]),
    text: text,
    completed: false
  }
  Nex.Store.update(:todos, [], &[todo | &1])
  
  assigns = %{todo: todo}
  ~H"<.todo_item todo={@todo} />"
end
```

**ä¼˜ç‚¹**:
- å±•ç¤ºäº†æ¡†æ¶çš„æ ¸å¿ƒä»·å€¼ï¼šç”¨ 10 è¡Œä»£ç å®ç°å®Œæ•´çš„ CRUD äº¤äº’
- Partial ç»„ä»¶å¤ç”¨è®¾è®¡è‰¯å¥½

### 7.2 Chatbot SSE ç¤ºä¾‹

**ä»£ç è´¨é‡**: â­â­â­â­

```elixir
def stream(params, send_fn) do
  # ...
  response_text
  |> String.graphemes()
  |> Enum.reduce("", fn char, acc ->
    new_content = acc <> char
    send_fn.(%{event: "message", data: new_content})
    Process.sleep(30)
    new_content
  end)
end
```

**ä¼˜ç‚¹**:
- æ¼”ç¤ºäº† SSE æµå¼å“åº”çš„å¼ºå¤§èƒ½åŠ›
- ä¸ HTMX SSE æ‰©å±•æ— ç¼é›†æˆ

**é—®é¢˜**:
- `Process.sleep(30)` åœ¨çœŸå® OpenAI æµå¼å“åº”ä¸­æ˜¯å¤šä½™çš„
- åº”å¤„ç†å®¢æˆ·ç«¯æ–­å¼€è¿æ¥çš„æƒ…å†µ

---

## 8. æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§æ’åº

### é«˜ä¼˜å…ˆçº§ ğŸ”´

1. **æ‹†åˆ† `Nex.Handler`**
   - æå– `Nex.Handler.Page`
   - æå– `Nex.Handler.Api`
   - æå– `Nex.Handler.SSE`
   - æå– `Nex.Handler.Error`

2. **ä¼˜åŒ– `Nex.Store.touch_page`**
```elixir
# å½“å‰: O(n) å†™æ“ä½œ
# å»ºè®®: O(1) å…ƒæ•°æ®æ›´æ–°
def touch_page(page_id) do
  :ets.insert(@table, {{:meta, page_id}, System.system_time(:millisecond)})
end
```

3. **å¢åŠ  CSRF é˜²æŠ¤é€‰é¡¹**
```elixir
# config.exs
config :nex, csrf_protection: true

# è‡ªåŠ¨åœ¨è¡¨å•ä¸­æ³¨å…¥ token
```

### ä¸­ä¼˜å…ˆçº§ ğŸŸ¡

4. **ç¼–è¯‘æ—¶è·¯ç”±ç”Ÿæˆ**: é¿å…è¿è¡Œæ—¶æ¨¡å—è§£æå¼€é”€

5. **å¢åŠ  `@spec` ç±»å‹è§„èŒƒ**: æå‡ä»£ç å¯ç»´æŠ¤æ€§å’Œå·¥å…·æ”¯æŒ

6. **SSE å¿ƒè·³æœºåˆ¶**: é˜²æ­¢é•¿è¿æ¥è¶…æ—¶

7. **ç”Ÿäº§ç¯å¢ƒçƒ­é‡è½½ç¦ç”¨**:
```elixir
def init(_opts) do
  if Mix.env() == :dev do
    # å¯åŠ¨æ–‡ä»¶ç›‘å¬
  else
    {:ok, %{watcher: nil, last_reload: 0}}
  end
end
```

### ä½ä¼˜å…ˆçº§ ğŸŸ¢

8. **æ”¯æŒ `[param]` æ–‡ä»¶åçº¦å®š**: æ›´çµæ´»çš„åŠ¨æ€è·¯ç”±

9. **æ’ä»¶/ä¸­é—´ä»¶ç³»ç»Ÿ**: å…è®¸ç”¨æˆ·æ³¨å…¥è‡ªå®šä¹‰å¤„ç†é€»è¾‘

10. **æµ‹è¯•è¾…åŠ©æ¨¡å—**: ç±»ä¼¼ `Phoenix.ConnTest` çš„æµ‹è¯•å·¥å…·

---

## 9. æ€»ç»“ä¸å±•æœ›

### 9.1 æ¡†æ¶å®šä½

Nex æˆåŠŸåœ°åœ¨ Elixir Web å¼€å‘é¢†åŸŸå¼€è¾Ÿäº†ä¸€ä¸ªç‹¬ç‰¹çš„ç”Ÿæ€ä½ï¼š

```
å¤æ‚åº¦è°±ç³»:
[Plug] â†â€”â€”â€” [Nex] â†â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” [Phoenix] â†â€” [Phoenix LiveView]
 çº¯è·¯ç”±      HTMXå¢å¼º            å…¨åŠŸèƒ½æ¡†æ¶     å®æ—¶åŒå‘é€šä¿¡
```

### 9.2 æ ¸å¿ƒä¼˜åŠ¿

1. **æç®€ä¸»ä¹‰**: ~1200 è¡Œæ ¸å¿ƒä»£ç ï¼Œæ˜“äºç†è§£å’Œè´¡çŒ®
2. **HTMX ä¼˜å…ˆ**: æ‹¥æŠ±è¶…åª’ä½“æ¶æ„ï¼Œå‡å°‘å®¢æˆ·ç«¯å¤æ‚æ€§
3. **çº¦å®šä¼˜äºé…ç½®**: æ–‡ä»¶è·¯å¾„å³è·¯ç”±ï¼Œé›¶é…ç½®å¯åŠ¨
4. **Elixir åŸç”Ÿ**: å……åˆ†åˆ©ç”¨ OTPã€ETSã€GenServer ç­‰åŸè¯­

### 9.3 é€‚ç”¨åœºæ™¯

âœ… **æ¨èä½¿ç”¨**:
- å†…éƒ¨ç®¡ç†å·¥å…·
- åŸå‹å’Œ MVP
- CRUD å¯†é›†å‹åº”ç”¨
- å¯¹ JavaScript æœ‰æ´ç™–çš„å›¢é˜Ÿ

âŒ **ä¸æ¨èä½¿ç”¨**:
- éœ€è¦å¤æ‚å®æ—¶åä½œçš„åº”ç”¨
- é«˜åº¦äº¤äº’çš„å¯Œå®¢æˆ·ç«¯åº”ç”¨
- éœ€è¦ç¦»çº¿æ”¯æŒçš„ PWA

### 9.4 æœ€ç»ˆè¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æ¶æ„è®¾è®¡ | 8/10 | æ¸…æ™°ä½† Handler è¿‡äºé›†ä¸­ |
| ä»£ç è´¨é‡ | 8/10 | ç®€æ´ã€æƒ¯ç”¨ã€ä½†ç¼ºå°‘ç±»å‹è§„èŒƒ |
| å®‰å…¨æ€§ | 7/10 | åŸºç¡€é˜²æŠ¤åˆ°ä½ï¼Œç¼ºå°‘ CSRF |
| æ€§èƒ½ | 7/10 | è¶³å¤Ÿï¼Œä½†æœ‰ä¼˜åŒ–ç©ºé—´ |
| å¼€å‘ä½“éªŒ | 9/10 | çƒ­é‡è½½ã€çº¦å®šè·¯ç”±ã€ä½“éªŒæµç•… |
| æ–‡æ¡£å®Œæ•´æ€§ | 6/10 | ä»£ç å†…æ–‡æ¡£è‰¯å¥½ï¼Œç”¨æˆ·æ–‡æ¡£å¾…å®Œå–„ |
| **æ€»ä½“** | **7.5/10** | ä¼˜ç§€çš„æ—©æœŸç‰ˆæœ¬ï¼Œå€¼å¾—å…³æ³¨ |

### 9.5 å¯„è¯­

ä½œä¸º Elixir çš„åˆ›å§‹äººï¼Œæˆ‘å¾ˆé«˜å…´çœ‹åˆ°ç¤¾åŒºåœ¨æ¢ç´¢ä¸åŒçš„ Web å¼€å‘èŒƒå¼ã€‚Nex è¯æ˜äº† **ç®€å•å¹¶ä¸æ„å‘³ç€ç®€é™‹**ã€‚å®ƒæé†’æˆ‘ä»¬ï¼šæœ‰æ—¶å€™ï¼Œæœ€å¥½çš„ä»£ç æ˜¯ä½ ä¸éœ€è¦å†™çš„ä»£ç ã€‚

ç»§ç»­ä¿æŒè¿™ç§æç®€ä¸»ä¹‰ç²¾ç¥ï¼ŒåŒæ—¶æ³¨æ„ï¼š
- ä¸è¦ä¸ºäº†ç®€å•è€Œç‰ºç‰²æ­£ç¡®æ€§
- éšç€æ¡†æ¶æˆç†Ÿï¼Œé€‚æ—¶å¼•å…¥å¿…è¦çš„æŠ½è±¡
- ä¿æŒä¸ Elixir ç”Ÿæ€ç³»ç»Ÿçš„è‰¯å¥½é›†æˆ

æœŸå¾… Nex çš„æœªæ¥å‘å±•ï¼

---

**JosÃ© Valim**  
*Elixir Creator & Dashbit Co-founder*

---

## é™„å½• A: ä»£ç å®¡è®¡æ¸…å•

- [x] `Nex.Handler` - æ ¸å¿ƒè¯·æ±‚å¤„ç†
- [x] `Nex.Store` - çŠ¶æ€ç®¡ç†
- [x] `Nex.Router` - è·¯ç”±å…¥å£
- [x] `Nex.Page` - é¡µé¢æ¨¡å—å®
- [x] `Nex.Api` - API æ¨¡å—å®
- [x] `Nex.SSE` - SSE è¡Œä¸ºå®šä¹‰
- [x] `Nex.Partial` - ç»„ä»¶æ¨¡å—å®
- [x] `Nex.Env` - ç¯å¢ƒå˜é‡ç®¡ç†
- [x] `Nex.Supervisor` - è¿›ç¨‹ç›‘ç£
- [x] `Nex.Reloader` - çƒ­é‡è½½
- [x] `Nex.LiveReloadSocket` - WebSocket çƒ­é‡è½½
- [x] `Mix.Tasks.Nex.Dev` - å¼€å‘æœåŠ¡å™¨ä»»åŠ¡
- [x] ç¤ºä¾‹é¡¹ç›® (todos, chatbot, chatbot_sse, guestbook)

## é™„å½• B: ä¾èµ–ç‰ˆæœ¬åˆ†æ

```elixir
# framework/mix.exs
{:bandit, "~> 1.9"},      # HTTP æœåŠ¡å™¨ - ç°ä»£ã€é«˜æ€§èƒ½
{:plug, "~> 1.19"},        # HTTP æŠ½è±¡å±‚
{:phoenix_html, "~> 4.3"}, # HTML è¾…åŠ©å‡½æ•°
{:phoenix_live_view, "~> 1.0"}, # HEEx æ¨¡æ¿å¼•æ“
{:jason, "~> 1.4"},        # JSON ç¼–è§£ç 
{:dotenvy, "~> 0.9"},      # .env æ–‡ä»¶åŠ è½½
{:file_system, "~> 1.0"}   # æ–‡ä»¶ç³»ç»Ÿç›‘å¬
```

æ‰€æœ‰ä¾èµ–éƒ½æ˜¯ç»´æŠ¤è‰¯å¥½çš„ä¸»æµåº“ï¼Œç‰ˆæœ¬é€‰æ‹©åˆç†ã€‚
