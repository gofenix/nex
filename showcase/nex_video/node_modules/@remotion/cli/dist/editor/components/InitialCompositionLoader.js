"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.InitialCompositionLoader = exports.useSelectComposition = void 0;
const react_1 = require("react");
const remotion_1 = require("remotion");
const folders_1 = require("../state/folders");
const CompositionSelector_1 = require("./CompositionSelector");
const FramePersistor_1 = require("./FramePersistor");
const useSelectComposition = () => {
    const { setFoldersExpanded } = (0, react_1.useContext)(folders_1.FolderContext);
    const { setCurrentComposition } = (0, react_1.useContext)(remotion_1.Internals.CompositionManager);
    return (c, push) => {
        if (push) {
            window.history.pushState({}, 'Studio', `/${c.id}`);
        }
        setCurrentComposition(c.id);
        const { folderName, parentFolderName } = c;
        if (folderName !== null) {
            setFoldersExpanded((ex) => {
                const keysToExpand = (0, CompositionSelector_1.getKeysToExpand)(folderName, parentFolderName);
                const newState = {
                    ...ex,
                };
                for (const key of keysToExpand) {
                    newState[key] = true;
                }
                return newState;
            });
        }
    };
};
exports.useSelectComposition = useSelectComposition;
const InitialCompositionLoader = () => {
    const { compositions, currentComposition } = (0, react_1.useContext)(remotion_1.Internals.CompositionManager);
    const selectComposition = (0, exports.useSelectComposition)();
    (0, react_1.useEffect)(() => {
        if (currentComposition) {
            return;
        }
        const compositionFromUrl = (0, FramePersistor_1.getCurrentCompositionFromUrl)();
        if (compositionFromUrl) {
            const exists = compositions.find((c) => c.id === compositionFromUrl);
            if (exists) {
                selectComposition(exists, true);
                return;
            }
        }
        if (compositions.length > 0) {
            selectComposition(compositions[0], true);
        }
    }, [compositions, currentComposition, selectComposition]);
    (0, react_1.useEffect)(() => {
        const onchange = () => {
            const newComp = window.location.pathname.substring(1);
            const exists = compositions.find((c) => c.id === newComp);
            if (exists) {
                selectComposition(exists, false);
            }
        };
        window.addEventListener('popstate', onchange);
        return () => window.removeEventListener('popstate', onchange);
    }, [compositions, selectComposition]);
    return null;
};
exports.InitialCompositionLoader = InitialCompositionLoader;
